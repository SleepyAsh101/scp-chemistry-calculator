<!DOCTYPE html>
<html>
<head>
  <title>SCP Chemistry Calculator</title>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      margin: 0;
      background: #111;
      color: #eee;
    }

    h1, h2, h3 { margin-top: 0; }

    .tabbar {
      display:flex;
      gap:10px;
      margin-bottom:20px;
    }
    .tab {
      padding:10px 18px;
      background:#222;
      border:1px solid #444;
      border-radius:8px;
      cursor:pointer;
      color:#ccc;
    }
    .tab.active {
      background:#3498db;
      border-color:#2980b9;
      color:white;
    }

    .page { display:none; }
    .page.active { display:block; }

    .box {
      background:#1a1a1a;
      border:1px solid #333;
      padding:15px;
      border-radius:8px;
      margin-bottom:20px;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px;
      margin: 5px 0;
      background: #222;
      color: #eee;
      border: 1px solid #444;
      border-radius: 4px;
    }

    button {
      padding: 9px 12px;
      width: 100%;
      margin-top: 8px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button.red { background:#c0392b; }
    button.yellow { background:#d4ac0d; color:#000; }

    .row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 0;
    }

    .node {
      margin-left:18px;
      border-left:1px solid #333;
      padding-left:10px;
    }
    .node-title {
      cursor:pointer;
      font-weight:bold;
      user-select:none;
      margin-bottom:5px;
    }
    .collapsed .node-children {
      display:none;
    }
  </style>
</head>
<body>

<h1>SCP Chemistry Calculator</h1>

<div class="tabbar">
  <div class="tab active" onclick="showPage('page-chems', this)">Chemicals</div>
  <div class="tab" onclick="showPage('page-builder', this)">Create Recipe</div>
  <div class="tab" onclick="showPage('page-recipes', this)">Recipes</div>
  <div class="tab" onclick="showPage('page-viewer', this)">Viewer</div>
  <div class="tab" onclick="showPage('page-batch', this)">Batch Calc</div>
  <div class="tab" onclick="showPage('page-profit', this)">Profit</div>
  <div class="tab" onclick="showPage('page-key', this)">Import/Export</div>
</div>

<!-- PAGE: CHEMICALS -->
<div id="page-chems" class="page active">
  <h2>Chemicals</h2>

  <div class="box">
    <input id="chemName" placeholder="Chemical Name">
    <input id="chemPrice" type="number" placeholder="Price per Liter">
    <button onclick="addChemical()">Add Chemical</button>
  </div>

  <div class="box">
    <h3>All Chemicals</h3>
    <div id="chemList"></div>
  </div>
</div>

<!-- PAGE: RECIPE BUILDER -->
<div id="page-builder" class="page">
  <h2>Create Recipe</h2>

  <div class="box">
    <input id="builderRecipeName" placeholder="Recipe Name">
    <input id="builderRecipeYield" type="number" placeholder="Yield %">

    <h3>Add Ingredient</h3>
    <select id="builderChemSelect"></select>
    <button onclick="builderAddIngredient()">Add Ingredient</button>

    <h3>Ingredients</h3>
    <div id="builderList"></div>

    <button onclick="saveNewRecipe()">Save Recipe</button>
  </div>
</div>

<!-- PAGE: SAVED RECIPES -->
<div id="page-recipes" class="page">
  <h2>Recipes</h2>
  <div id="savedRecipesList"></div>
</div>

<!-- PAGE: VIEWER -->
<div id="page-viewer" class="page">
  <h2>Viewer</h2>
  <select id="recipeViewSelect" onchange="viewRecipe()"></select>
  <div id="recipeViewBox" style="margin-top:15px;"></div>
</div>

<!-- PAGE: BATCH CALCULATOR -->
<div id="page-batch" class="page">
  <h2>Batch Calculator</h2>

  <select id="batchChemSelect"></select>
  <input id="batchLiters" type="number" placeholder="Desired Output (L)">
  <button onclick="calcBatch()">Calculate</button>

  <div id="batchOutput" style="margin-top:15px;"></div>
</div>

<!-- PAGE: PROFIT -->
<div id="page-profit" class="page">
  <h2>Profit Calculator</h2>

  <select id="profitChemSelect"></select>
  <input id="profitSalePrice" type="number" placeholder="Sale Price/L">

  <button onclick="calcProfit()">Calculate</button>
  <div id="profitOutput" style="margin-top:15px;"></div>
</div>

<!-- PAGE: IMPORT / EXPORT -->
<div id="page-key" class="page">
  <h2>Import / Export</h2>

  <button onclick="exportKey()">Export</button>
  <textarea id="exportBox" style="height:80px;"></textarea>

  <textarea id="importBox" style="height:80px;" placeholder="Paste key"></textarea>
  <button onclick="importKey()">Import</button>
</div>


<script>
// Load from browser storage
let prices = JSON.parse(localStorage.getItem("chem_prices") || "{}");
let savedRecipes = JSON.parse(localStorage.getItem("chem_recipes") || "{}");
let recipeBuilder = [];

/* TAB SYSTEM */
function showPage(id, tabBtn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  tabBtn.classList.add('active');
  saveState();
}

/* SAVE STATE */
function saveState() {
  localStorage.setItem("chem_prices", JSON.stringify(prices));
  localStorage.setItem("chem_recipes", JSON.stringify(savedRecipes));
}

/* REFRESH UI */
function refreshAll() {
  refreshChemicalList();
  refreshBuilderChemList();
  refreshSavedRecipeList();
  refreshRecipeSelects();
  refreshBatchList();
  refreshProfitList();
}

/* ============ CHEMICALS ============ */
function refreshChemicalList() {
  const box = document.getElementById('chemList');
  box.innerHTML = "";
  Object.keys(prices).forEach(name => {
    box.innerHTML += `
      <div class="row">
        <div>${name} — $${prices[name].toFixed(2)}/L</div>
        <div style="display:flex; gap:5px;">
          <button class="yellow" style="width:80px" onclick="editChemical('${name}')">Edit</button>
          <button class="red" style="width:80px" onclick="deleteChemical('${name}')">Delete</button>
        </div>
      </div>`;
  });
}

function addChemical() {
  let name = document.getElementById('chemName').value.trim().toLowerCase();
  let price = parseFloat(document.getElementById('chemPrice').value);
  if (!name || isNaN(price)) return;
  prices[name] = price;
  document.getElementById('chemName').value = "";
  document.getElementById('chemPrice').value = "";
  saveState();
  refreshAll();
}

function editChemical(name) {
  const newPrice = parseFloat(prompt("New price per liter:", prices[name]));
  if (!isNaN(newPrice)) {
    prices[name] = newPrice;
    saveState();
    refreshAll();
  }
}

function deleteChemical(name) {
  if (confirm("Delete chemical " + name + "?")) {
    delete prices[name];
    saveState();
    refreshAll();
  }
}

/* ============ BUILDER ============ */
function refreshBuilderChemList() {
  const sel = document.getElementById('builderChemSelect');
  sel.innerHTML = `<option value="">-- choose --</option>`;
  Object.keys(prices).forEach(n => sel.innerHTML += `<option value="${n}">${n}</option>`);
}

function builderAddIngredient() {
  const chem = document.getElementById('builderChemSelect').value;
  if (!chem) return;
  recipeBuilder.push({ name: chem, liters: 0 });
  updateBuilderList();
}

function updateBuilderList() {
  const box = document.getElementById('builderList');
  box.innerHTML = "";
  recipeBuilder.forEach((item, i) => {
    box.innerHTML += `
      <div class="row">
        <div style="width:70%">
          <b>${item.name}</b>
          <input type="number" value="${item.liters}" 
            onchange="recipeBuilder[${i}].liters = parseFloat(this.value)||0">
        </div>
        <button class="red" style="width:60px" onclick="removeBuilderIngredient(${i})">X</button>
      </div>`;
  });
}

function removeBuilderIngredient(idx) {
  recipeBuilder.splice(idx, 1);
  updateBuilderList();
}

/* SAVE RECIPE */
function saveNewRecipe() {
  const name = document.getElementById('builderRecipeName').value.trim().toLowerCase();
  let yieldVal = parseFloat(document.getElementById('builderRecipeYield').value);
  if (!name || recipeBuilder.length === 0) return;
  if (isNaN(yieldVal)) yieldVal = 100;

  savedRecipes[name] = {
    yield: yieldVal,
    ingredients: JSON.parse(JSON.stringify(recipeBuilder))
  };

  calculateRecipePrice(name);
  saveState();

  recipeBuilder = [];
  document.getElementById('builderRecipeName').value = "";
  document.getElementById('builderRecipeYield').value = "";
  updateBuilderList();
  refreshAll();
}

/* NESTED EXPANSION */
function expandRecipe(name, batches) {
  const rec = savedRecipes[name];
  if (!rec) return { outputLiters: 0, totalCost: 0 };

  let inputLiters = 0, cost = 0;

  for (let ing of rec.ingredients) {
    const req = ing.liters * batches;

    if (savedRecipes[ing.name]) {
      const nested = expandRecipe(ing.name, req);
      inputLiters += nested.outputLiters;
      cost += nested.totalCost;
    } else {
      inputLiters += req;
      cost += (prices[ing.name] || 0) * req;
    }
  }

  const output = inputLiters * (rec.yield / 100);
  return { outputLiters: output, totalCost: cost };
}

/* TRUE COST / L */
function calculateRecipePrice(name) {
  const data = expandRecipe(name, 1);
  prices[name] = data.outputLiters > 0 ? data.totalCost / data.outputLiters : 0;
  saveState();
}

/* ============ VIEWER TREE ============ */
function refreshRecipeSelects() {
  const sel = document.getElementById('recipeViewSelect');
  sel.innerHTML = `<option value="">-- choose --</option>`;
  Object.keys(savedRecipes).forEach(n => sel.innerHTML += `<option value="${n}">${n}</option>`);
}

function viewRecipe() {
  const name = document.getElementById('recipeViewSelect').value;
  const box = document.getElementById('recipeViewBox');
  if (!name) {
    box.innerHTML = "Select a recipe.";
    return;
  }
  box.innerHTML = buildRecipeTree(name, 0);
}

function buildRecipeTree(name, depth) {
  const rec = savedRecipes[name];
  const expanded = rec.ingredients.length <= 4 || depth === 0;

  const calc = expandRecipe(name, 1);
  const costPerL = calc.totalCost / calc.outputLiters || 0;

  let html = `
    <div class="node ${expanded ? "" : "collapsed"}">
      <div class="node-title" onclick="toggleNode(this.parentElement)">
        ▼ ${name} — Yield ${rec.yield}% — $${costPerL.toFixed(2)}/L
      </div>
      <div class="node-children">
  `;

  rec.ingredients.forEach(ing => {
    if (savedRecipes[ing.name]) {
      html += buildRecipeTree(ing.name, depth + 1);
    } else {
      html += `<div class="node">• ${ing.name}: ${ing.liters} L @ $${(prices[ing.name]||0).toFixed(2)}/L</div>`;
    }
  });

  html += `</div></div>`;
  return html;
}

function toggleNode(n) { n.classList.toggle("collapsed"); }

/* ============ EDIT / DELETE RECIPES ============ */
function refreshSavedRecipeList() {
  const div = document.getElementById('savedRecipesList');
  div.innerHTML = "";
  Object.keys(savedRecipes).forEach(name => {
    div.innerHTML += `
      <div class="row">
        <div>${name} — Yield ${savedRecipes[name].yield}%</div>
        <div style="display:flex; gap:5px;">
          <button class="yellow" style="width:80px" onclick="editRecipe('${name}')">Edit</button>
          <button class="red" style="width:80px" onclick="deleteRecipe('${name}')">Delete</button>
        </div>
      </div>`;
  });
}

function editRecipe(name) {
  const rec = savedRecipes[name];
  const newYield = parseFloat(prompt("New yield %:", rec.yield));
  if (!isNaN(newYield)) {
    rec.yield = newYield;
    calculateRecipePrice(name);
    saveState();
    refreshAll();
  }
}

function deleteRecipe(name) {
  if (confirm("Delete recipe " + name + "?")) {
    delete savedRecipes[name];
    saveState();
    refreshAll();
  }
}

/* ============ BATCH CALCULATOR ============ */
function refreshBatchList() {
  const sel = document.getElementById('batchChemSelect');
  sel.innerHTML = `<option value="">-- choose --</option>`;
  Object.keys(savedRecipes).forEach(n => sel.innerHTML += `<option value="${n}">${n}</option>`);
}

function calcBatch() {
  const name = document.getElementById('batchChemSelect').value;
  const desired = parseFloat(document.getElementById('batchLiters').value);
  const box = document.getElementById('batchOutput');

  if (!name || !desired) {
    box.innerHTML = "Missing input.";
    return;
  }

  const base = expandRecipe(name, 1);
  if (base.outputLiters <= 0) {
    box.innerHTML = "Yield is 0% — cannot calculate.";
    return;
  }

  const batches = desired / base.outputLiters;
  box.innerHTML = `<h3>${desired} L of ${name} requires:</h3><br>` + 
                  expandBatchReq(name, batches);
}

function expandBatchReq(name, batches) {
  const rec = savedRecipes[name];
  let html = "";
  rec.ingredients.forEach(ing => {
    const total = ing.liters * batches;
    if (savedRecipes[ing.name]) {
      html += `<div class="node">▼ ${ing.name}: ${total.toFixed(2)} L</div>`;
      html += expandBatchReq(ing.name, total);
    } else {
      html += `<div class="node">• ${ing.name}: ${total.toFixed(2)} L</div>`;
    }
  });
  return html;
}

/* ============ PROFIT ============ */
function refreshProfitList() {
  const sel = document.getElementById('profitChemSelect');
  sel.innerHTML = `<option value="">-- choose --</option>`;
  Object.keys(savedRecipes).forEach(n => sel.innerHTML += `<option value="${n}">${n}</option>`);
}

function calcProfit() {
  const name = document.getElementById('profitChemSelect').value;
  const sale = parseFloat(document.getElementById('profitSalePrice').value);
  const out = document.getElementById('profitOutput');

  if (!name || !sale) {
    out.innerHTML = "Missing input.";
    return;
  }

  const data = expandRecipe(name, 1);
  const cost = data.totalCost / data.outputLiters || 0;
  const profit = sale - cost;
  const margin = (profit / sale) * 100;

  out.innerHTML = `
    <div>Cost/L: $${cost.toFixed(2)}</div>
    <div>Sale Price/L: $${sale.toFixed(2)}</div>
    <div>Profit/L: $${profit.toFixed(2)}</div>
    <div>Margin: ${margin.toFixed(2)}%</div>`;
}

/* ============ IMPORT / EXPORT ============ */
function exportKey() {
  const key = btoa(JSON.stringify({ prices, savedRecipes }));
  document.getElementById('exportBox').value = key;
}

function importKey() {
  try {
    const data = JSON.parse(atob(document.getElementById('importBox').value.trim()));
    prices = data.prices || {};
    savedRecipes = data.savedRecipes || {};
    saveState();
    refreshAll();
    alert("Imported successfully!");
  } catch {
    alert("Invalid key.");
  }
}

/* INIT */
function loadSaved() {
  refreshAll();
  refreshProfitList();
}
loadSaved();
</script>

</body>
</html>
