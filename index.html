<!DOCTYPE html>
<html>
<head>
  <title>SCP Chemistry Calculator</title>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      margin: 0;
      background: #111;
      color: #eee;
    }
    h1, h2, h3 { margin-top: 0; }

    /* ===================== Tabs ===================== */
    .tabbar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .tab {
      padding: 8px 14px;
      background: #222;
      border: 1px solid #444;
      border-radius: 6px;
      cursor: pointer;
      color: #ddd;
      user-select: none;
    }
    .tab.active {
      background: #3498db;
      border-color: #2980b9;
      color: white;
    }

    /* ===================== Pages ===================== */
    .page { display: none; }
    .page.active { display: block; }

    /* ===================== UI Boxes ===================== */
    .box {
      background: #1a1a1a;
      border: 1px solid #333;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px;
      margin: 5px 0 10px 0;
      background: #222;
      color: #eee;
      border: 1px solid #444;
      border-radius: 4px;
    }

    button {
      padding: 9px 12px;
      width: 100%;
      margin-top: 8px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button.red { background: #c0392b; }
    button.yellow { background: #d4ac0d; color:#000; }

    /* ===================== Ingredient Row ===================== */
    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 3px 0;
      padding: 4px;
    }

    /* Small square X button */
    .xbtn {
      background: #c0392b;
      border: 1px solid #922b21;
      color: white;
      width: 26px;
      height: 26px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      line-height: 20px;
    }

    /* ===================== Tree View ===================== */
    .node { margin-left: 12px; }
    .node-title { cursor: pointer; font-weight: bold; margin: 4px 0; }
    .collapsed .node-children { display:none; }
  </style>
</head>
<body>

<h1>SCP Chemistry Calculator</h1>

<!-- ============================================================
     TABS
============================================================ -->
<div class="tabbar">
  <div class="tab active" onclick="showPage('page-chems', this)">Chemicals</div>
  <div class="tab" onclick="showPage('page-builder', this)">Recipe Builder</div>
  <div class="tab" onclick="showPage('page-recipes', this)">Recipes</div>
  <div class="tab" onclick="showPage('page-viewer', this)">Recipe Viewer</div>
  <div class="tab" onclick="showPage('page-batch', this)">Batch Calc</div>
  <div class="tab" onclick="showPage('page-profit', this)">Profit</div>
  <div class="tab" onclick="showPage('page-key', this)">Key</div>
</div>

<!-- ============================================================
     PAGE: CHEMICALS
============================================================ -->
<div id="page-chems" class="page active">
  <h2>Chemicals</h2>

  <div class="box">
    <input id="chemName" placeholder="Chemical Name">
    <input id="chemPrice" type="number" placeholder="Price per Liter">
    <button onclick="addChemical()">Add Chemical</button>
  </div>

  <div class="box">
    <h3>All Chemicals</h3>
    <div id="chemList"></div>
  </div>
</div>

<!-- ============================================================
     PAGE: RECIPE BUILDER
============================================================ -->
<div id="page-builder" class="page">
  <h2>Create Recipe</h2>

  <div class="box">
    <input id="builderRecipeName" placeholder="Recipe Name">
    <input id="builderRecipeYield" type="number" placeholder="Yield % (e.g. 24.8)">
  </div>

  <div class="box">
    <h3>Add Ingredient</h3>
    <select id="builderChemSelect"></select>
    <button onclick="builderAddIngredient()">Add Ingredient</button>

    <h3>Ingredients</h3>
    <div id="builderList"></div>

    <button onclick="saveNewRecipe()">Save Recipe</button>
  </div>
</div>

<!-- ============================================================
     PAGE: SAVED RECIPES
============================================================ -->
<div id="page-recipes" class="page">
  <h2>Saved Recipes</h2>
  <div id="savedRecipesList"></div>
</div>

<!-- ============================================================
     PAGE: VIEW RECIPE TREE
============================================================ -->
<div id="page-viewer" class="page">
  <h2>Recipe Viewer</h2>

  <select id="recipeViewSelect" onchange="viewRecipe()"></select>

  <div id="recipeViewBox" style="margin-top:15px;"></div>
</div>

<!-- ============================================================
     PAGE: BATCH CALCULATOR
============================================================ -->
<div id="page-batch" class="page">
  <h2>Batch Calculator</h2>

  <select id="batchChemSelect"></select>
  <input id="batchLiters" type="number" placeholder="Desired Output Liters">

  <button onclick="calcBatch()">Calculate</button>

  <div id="batchOutput" style="margin-top:15px;"></div>
</div>

<!-- ============================================================
     PAGE: PROFIT CALC
============================================================ -->
<div id="page-profit" class="page">
  <h2>Profit Calculator</h2>

  <select id="profitChemSelect"></select>
  <input id="profitSalePrice" type="number" placeholder="Sale Price per Liter">

  <button onclick="calcProfit()">Calculate</button>

  <div id="profitOutput" style="margin-top:10px;"></div>
</div>

<!-- ============================================================
     PAGE: IMPORT / EXPORT
============================================================ -->
<div id="page-key" class="page">
  <h2>Export / Import Key</h2>

  <button onclick="exportKey()">Export Key</button>
  <textarea id="exportBox" style="height:80px"></textarea>

  <textarea id="importBox" placeholder="Paste key" style="height:80px"></textarea>
  <button onclick="importKey()">Import</button>
</div>

<!-- ========================== SCRIPT ========================== -->
<script>

/* ================= GLOBAL VARIABLES ================= */
let prices = {};
let savedRecipes = {};
let recipeBuilder = [];

/* ================= TAB SWITCHING ================= */
function showPage(id, tabBtn) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  tabBtn.classList.add("active");
}

/* ================= REFRESH ALL UI ================= */
function refreshAll() {
  refreshChemicalList();
  refreshRecipeLists();
  refreshDropdowns();
}

/* ================= CHEMICALS ================= */
function addChemical() {
  let name = document.getElementById("chemName").value.trim().toLowerCase();
  let price = parseFloat(document.getElementById("chemPrice").value);

  if (!name || isNaN(price)) return;

  prices[name] = price;

  document.getElementById("chemName").value = "";
  document.getElementById("chemPrice").value = "";

  refreshAll();
}

function refreshChemicalList() {
  const box = document.getElementById("chemList");
  box.innerHTML = "";

  Object.keys(prices).forEach(name => {
    box.innerHTML += `
      <div class="row">
        <div>${name} — $${prices[name].toFixed(2)}/L</div>
        <button class="xbtn" onclick="deleteChemical('${name}')">X</button>
      </div>
    `;
  });
}

function deleteChemical(name) {
  if (!confirm(`Delete chemical ${name}?`)) return;
  delete prices[name];
  refreshAll();
}

/* ================= RECIPE BUILDER ================= */
function builderAddIngredient() {
  const name = document.getElementById("builderChemSelect").value;
  if (!name) return;

  recipeBuilder.push({ name, liters: 0 });
  updateBuilderList();
}

function updateBuilderList() {
  const box = document.getElementById("builderList");
  box.innerHTML = "";

  recipeBuilder.forEach((i, idx) => {
    box.innerHTML += `
      <div class="row">
        <div>
          <b>${i.name}</b>
          <input type="number" value="${i.liters}"
            onchange="recipeBuilder[${idx}].liters = parseFloat(this.value)||0">
        </div>
        <button class="xbtn" onclick="removeBuilderIngredient(${idx})">X</button>
      </div>
    `;
  });
}

function removeBuilderIngredient(idx) {
  recipeBuilder.splice(idx, 1);
  updateBuilderList();
}

function saveNewRecipe() {
  const name = document.getElementById("builderRecipeName").value.trim().toLowerCase();
  let yieldVal = parseFloat(document.getElementById("builderRecipeYield").value);

  if (!name || recipeBuilder.length === 0) return;
  if (isNaN(yieldVal)) yieldVal = 100;

  savedRecipes[name] = {
    yield: yieldVal,
    ingredients: JSON.parse(JSON.stringify(recipeBuilder))
  };

  calculateRecipePrice(name);

  recipeBuilder = [];
  updateBuilderList();
  document.getElementById("builderRecipeName").value = "";
  document.getElementById("builderRecipeYield").value = "";

  refreshAll();
}

/* ================= CALCULATE RECIPE PRICE ================= */
function calculateRecipePrice(name) {
  const { outputLiters, totalCost } = expandRecipe(name, 1);
  prices[name] = outputLiters > 0 ? totalCost / outputLiters : 0;
}

/* ================= EXPAND RECIPE ================= */
function expandRecipe(name, batches) {
  const rec = savedRecipes[name];
  if (!rec) return { outputLiters: 0, totalCost: 0 };

  let inputLit = 0;
  let cost = 0;

  for (let ing of rec.ingredients) {
    let need = ing.liters * batches;

    if (savedRecipes[ing.name]) {
      let nested = expandRecipe(ing.name, need);
      inputLit += nested.outputLiters;
      cost += nested.totalCost;
    } else {
      inputLit += need;
      cost += (prices[ing.name] || 0) * need;
    }
  }

  return {
    outputLiters: inputLit * (rec.yield / 100),
    totalCost: cost
  };
}

/* ================= VIEWER TREE ================= */
function viewRecipe() {
  const name = document.getElementById("recipeViewSelect").value;
  const box = document.getElementById("recipeViewBox");

  if (!name) { box.innerHTML = "Select a recipe."; return; }

  box.innerHTML = buildTree(name);
}

function buildTree(name) {
  const r = savedRecipes[name];

  let { outputLiters, totalCost } = expandRecipe(name, 1);
  let costL = totalCost / outputLiters;

  let html = `
    <div class="node">
      <div class="node-title" onclick="this.parentElement.classList.toggle('collapsed')">
        ▼ ${name} — Yield ${r.yield}% — $${costL.toFixed(2)}/L
      </div>
      <div class="node-children">
  `;

  r.ingredients.forEach(i => {
    if (savedRecipes[i.name]) {
      html += buildTree(i.name);
    } else {
      html += `<div class="node">• ${i.name}: ${i.liters} L</div>`;
    }
  });

  return html + "</div></div>";
}

/* ================= SAVED RECIPE LIST ================= */
function refreshRecipeLists() {
  const box = document.getElementById("savedRecipesList");
  box.innerHTML = "";

  Object.keys(savedRecipes).forEach(name => {
    box.innerHTML += `
      <div class="row">
        <div>${name} — Yield ${savedRecipes[name].yield}%</div>
        <button class="xbtn" onclick="deleteRecipe('${name}')">X</button>
      </div>
    `;
  });
}

function deleteRecipe(name) {
  if (!confirm(`Delete recipe ${name}?`)) return;
  delete savedRecipes[name];
  refreshAll();
}

/* ================= BATCH CALCULATOR ================= */
function calcBatch() {
  const name = document.getElementById("batchChemSelect").value;
  const desired = parseFloat(document.getElementById("batchLiters").value);
  const out = document.getElementById("batchOutput");

  if (!name || !desired) { out.innerHTML = "Missing input."; return; }

  const batch1 = expandRecipe(name, 1);
  const batchesNeeded = desired / batch1.outputLiters;

  let html = `<h3>${desired} L of ${name} requires:</h3>`;

  html += expandBatch(name, batchesNeeded);

  out.innerHTML = html;
}

function expandBatch(name, batches) {
  let html = "";
  const rec = savedRecipes[name];

  for (let ing of rec.ingredients) {
    let total = ing.liters * batches;

    if (savedRecipes[ing.name]) {
      html += `<div class="node">▼ ${ing.name}: ${total.toFixed(2)} L</div>`;
      html += expandBatch(ing.name, total);
    } else {
      html += `<div class="node">• ${ing.name}: ${total.toFixed(2)} L</div>`;
    }
  }

  return html;
}

/* ================= PROFIT CALC ================= */
function calcProfit() {
  const name = document.getElementById("profitChemSelect").value;
  const price = parseFloat(document.getElementById("profitSalePrice").value);
  const box = document.getElementById("profitOutput");

  if (!name || isNaN(price)) { box.innerHTML = "Missing input."; return; }

  const r = expandRecipe(name, 1);

  let costL = r.totalCost / r.outputLiters;
  let profit = price - costL;

  box.innerHTML = `
    Cost/L: $${costL.toFixed(2)}<br>
    Sale: $${price.toFixed(2)}<br>
    Profit: $${profit.toFixed(2)}<br>
    Margin: ${(profit/price*100).toFixed(1)}%
  `;
}

/* ================= IMPORT / EXPORT ================= */
function exportKey() {
  const key = btoa(JSON.stringify({ prices, savedRecipes }));
  document.getElementById("exportBox").value = key;
}

function importKey() {
  try {
    const raw = atob(document.getElementById("importBox").value.trim());
    const data = JSON.parse(raw);
    prices = data.prices || {};
    savedRecipes = data.savedRecipes || {};
    refreshAll();
    alert("Key Loaded");
  } catch {
    alert("Invalid Key");
  }
}

/* ================= DROPDOWNS ================= */
function refreshDropdowns() {
  const builder = document.getElementById("builderChemSelect");
  const view = document.getElementById("recipeViewSelect");
  const batch = document.getElementById("batchChemSelect");
  const profit = document.getElementById("profitChemSelect");

  builder.innerHTML = `<option value="">-- choose --</option>`;
  Object.keys(prices).forEach(n => builder.innerHTML += `<option value="${n}">${n}</option>`);

  view.innerHTML = `<option value="">-- choose --</option>`;
  Object.keys(savedRecipes).forEach(n => view.innerHTML += `<option value="${n}">${n}</option>`);

  batch.innerHTML = `<option value="">-- choose --</option>`;
  Object.keys(savedRecipes).forEach(n => batch.innerHTML += `<option value="${n}">${n}</option>`);

  profit.innerHTML = `<option value="">-- choose --</option>`;
  Object.keys(savedRecipes).forEach(n => profit.innerHTML += `<option value="${n}">${n}</option>`);
}

/* ================= INITIAL LOAD ================= */
refreshAll();

</script>

</body>
</html>
